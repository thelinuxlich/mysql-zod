import z from"node:path";import T from"camelcase";import F from"fs-extra";import j from"knex";function E(s,m,b,u,o,i){const g=i.nullish&&i.nullish===!0,t=b!==null,r=u.includes("DEFAULT_GENERATED"),e=i.requiredString&&i.requiredString===!0,d=i.useDateType&&i.useDateType===!0,h=s.split("(")[0].split(" ")[0],n=o==="YES",$=["z.string().datetime()"],a=["z.string()"],c=["z.number()"],l=["z.boolean()"],p=g?"nullish()":"nullable()",f="optional()",x="email()",w="nonnegative()",C="min(1)";switch(h){case"date":case"datetime":case"timestamp":const y=d?$:a;return t&&!r&&y.push(`default('${u}')`),n?y.push(p):t&&y.push(f),y.join(".");case"time":case"year":case"char":case"varchar":return m.toLowerCase().includes("email")&&a.push(x),t&&!r&&a.push(`default('${u}')`),n?a.push(p):e?a.push(C):t&&a.push(f),a.join(".");case"tinytext":case"text":case"mediumtext":case"longtext":case"json":case"decimal":return t&&!r&&a.push(`default('${u}')`),n?a.push(p):e?a.push(C):t&&a.push(f),a.join(".");case"tinyint":return t&&!r&&l.push(`default(${u})`),n?l.push(p):t&&l.push(f),l.join(".");case"smallint":case"mediumint":case"int":case"bigint":case"float":case"double":return s.endsWith(" unsigned")&&c.push(w),t&&!r&&c.push(`default(${u})`),n?c.push(p):t&&c.push(f),c.join(".");case"enum":const D=[`z.enum([${s.replace("enum(","").replace(")","").replace(/,/g,", ")}])`];return t&&!r&&D.push(`default('${u}')`),n?D.push(p):t&&D.push(f),D.join(".")}}async function W(s){const m=j({client:"mysql2",connection:{host:s.host,port:s.port,user:s.user,password:s.password,database:s.database,ssl:s.ssl??{}}}),b=s.camelCase&&s.camelCase===!0;let o=(await m.raw("SELECT table_name as table_name FROM information_schema.tables WHERE table_schema = ?",[s.database]))[0].map(e=>e.table_name).filter(e=>!e.startsWith("knex_")).sort();const i=s.tables;i&&i.length&&(o=o.filter(e=>i.includes(e)));const g=s.ignore,t=g?.filter(e=>e.startsWith("/")&&e.endsWith("/")),r=g?.filter(e=>!t?.includes(e));r&&r.length&&(o=o.filter(e=>!r.includes(e))),t&&t.length&&(o=o.filter(e=>{let d=!0;return t.forEach(h=>{const n=h.substring(1,h.length-1);e.match(n)!==null&&(d=!1)}),d}));for(let e of o){const h=(await m.raw(`DESC ${e}`))[0];b&&(e=T(e));let n=`import z from 'zod'

export const ${e} = z.object({`;for(const l of h){const p=b?T(l.Field):l.Field,f=E(l.Type,l.Field,l.Default,l.Extra,l.Null,s);n=`${n}
  ${p}: ${f},`}n=`${n}
})

export type ${T(`${e}Type`)} = z.infer<typeof ${e}>
`;const $=s.folder&&s.folder!==""?s.folder:".",a=s.suffix&&s.suffix!==""?`${e}.${s.suffix}.ts`:`${e}.ts`,c=z.join($,a);console.log("Created:",c),F.outputFileSync(c,n)}await m.destroy()}export{W as generate};
