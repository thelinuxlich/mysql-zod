import D from"node:path";import x from"camelcase";import C from"fs-extra";import F from"knex";function j(s,m,l,T,u,r){const b=r.nullish&&r.nullish===!0,t=l!==null,o=T.includes("DEFAULT_GENERATED"),e=r.requiredString&&r.requiredString===!0,f=r.useDateType&&r.useDateType===!0,h=s.split("(")[0].split(" ")[0],n=u==="YES",$=["z.union([z.number(), z.string(), z.date()]).pipe(z.coerce.date())"],a=["z.string()"],c=["z.number()"],i=["z.boolean()"],p=b?"nullish()":"nullable()",d="optional()",z="nonnegative()",E="min(1)";switch(h){case"date":case"datetime":case"timestamp":const g=f?$:a;return n?g.push(p):t&&g.push(d),t&&!o&&g.push(`default('${l}')`),g.join(".");case"time":case"year":case"char":case"varchar":return n?a.push(p):e?a.push(E):t&&a.push(d),t&&!o&&a.push(`default('${l}')`),a.join(".");case"tinytext":case"text":case"mediumtext":case"longtext":case"json":case"decimal":return n?a.push(p):e?a.push(E):t&&a.push(d),t&&!o&&a.push(`default('${l}')`),a.join(".");case"tinyint":return n?i.push(p):t&&i.push(d),t&&!o&&i.push(`default(${!!+l})`),i.join(".");case"smallint":case"mediumint":case"int":case"bigint":case"float":case"double":return s.endsWith(" unsigned")&&c.push(z),n?c.push(p):t&&c.push(d),t&&!o&&c.push(`default(${l})`),c.join(".");case"enum":const y=[`z.enum([${s.replace("enum(","").replace(")","").replace(/,/g,", ")}])`];return n?y.push(p):t&&y.push(d),t&&!o&&y.push(`default('${l}')`),y.join(".")}}async function v(s){const m=F({client:"mysql2",connection:{host:s.host,port:s.port,user:s.user,password:s.password,database:s.database,ssl:s.ssl}}),l=s.camelCase&&s.camelCase===!0;let u=(await m.raw("SELECT table_name as table_name FROM information_schema.tables WHERE table_schema = ?",[s.database]))[0].map(e=>e.table_name).filter(e=>!e.startsWith("knex_")).sort();const r=s.tables;r&&r.length&&(u=u.filter(e=>r.includes(e)));const b=s.ignore,t=b?.filter(e=>e.startsWith("/")&&e.endsWith("/")),o=b?.filter(e=>!t?.includes(e));o&&o.length&&(u=u.filter(e=>!o.includes(e))),t&&t.length&&(u=u.filter(e=>{let f=!0;return t.forEach(h=>{const n=h.substring(1,h.length-1);e.match(n)!==null&&(f=!1)}),f}));for(let e of u){const h=(await m.raw(`DESC ${e}`))[0];l&&(e=x(e));let n=`import z from 'zod'

export const ${e} = z.object({`;for(const i of h){const p=l?x(i.Field):i.Field,d=j(i.Type,i.Field,i.Default,i.Extra,i.Null,s);n=`${n}
  ${p}: ${d},`}n=`${n}
})

export type ${x(`${e}Type`)} = z.infer<typeof ${e}>
`;const $=s.folder&&s.folder!==""?s.folder:".",a=s.suffix&&s.suffix!==""?`${e}.${s.suffix}.ts`:`${e}.ts`,c=D.join($,a);console.log("Created:",c),C.outputFileSync(c,n)}await m.destroy()}export{v as generate};
